<!DOCTYPE html>
<html lang="en">

  <head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>英雄</title>

    <!-- Bootstrap core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom fonts for this template -->
    <link href="https://fonts.googleapis.com/css?family=Catamaran:100,200,300,400,500,600,700,800,900" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Lato:100,100i,300,300i,400,400i,700,700i,900,900i" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/one-page-wonder.min.css" rel="stylesheet">

  </head>

  <body>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom fixed-top">
      <div class="container">
        <a class="navbar-brand" href="#">英雄</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a class="nav-link" href="#">时代英雄</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="myHero.html">心中的英雄</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <header class="masthead text-center text-white">
      <div class="masthead-content">
        <div class="container">
          <h1 class="masthead-heading mb-0">英雄</h1>
          <h2 class="masthead-subheading mb-0">天地英雄气，千秋尚凛然</h2>
          <p>时代需要宣传英雄，英雄需要被历史记录。基于星云链的记录和宣传英雄事迹的平台。</p> 


          <div class="noExtensionClass"  id="noExtension">
                使用前请安装 
                <a target="_blank" href="https://github.com/ChengOrangeJu/WebExtensionWallet">WebExtensionWallet</a> 
                激活Dapp的功能。移动端请安装<a target="_blank" href="https://nano.nebulas.io/index_cn.html">NAS nano 钱包</a>
          </div>  

<!--           <div class="noExtensionClass" style="display:none" id="noExtension">
                    请安装 
            <a target="_blank" href="https://github.com/ChengOrangeJu/WebExtensionWallet">WebExtensionWallet</a> 激活Dapp的功能。
        </div>   -->



        </div>
      </div>
      <div class="bg-circle-1 bg-circle"></div>
      <div class="bg-circle-2 bg-circle"></div>
      <div class="bg-circle-3 bg-circle"></div>
      <div class="bg-circle-4 bg-circle"></div>
    </header>

    <section>
      <div class="container">
        <div class="row align-items-center">
          <div class="col-lg-6 order-lg-2">
            <div class="p-5">
              <img class="img-fluid rounded-circle" src="img/jiaoyulv.jpg" alt="">
            </div>
          </div>
          <div class="col-lg-6 order-lg-1">
            <div class="p-5">
              <h2 class="display-4" id="firstName"></h2>
              <p id="firstDescription"></p>
              <p id="firstIndex" style="display: none;"></p>
              <p id="firstCallNum"></p>

              <div class="content_show">
              <!-- <div class="content_show" style="display: none;"> -->
                <button type="button" class="btn btn-danger btn-default" onclick="call('firstIndex')">为他打call</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section>
      <div class="container">
        <div class="row align-items-center">
          <div class="col-lg-6">
            <div class="p-5">
              <img class="img-fluid rounded-circle" src="img/dengjiaxian.jpg" alt="">
            </div>
          </div>
          <div class="col-lg-6">
            <div class="p-5">
              <h2 class="display-4" id="secondName"></h2>
              <p id="secondDescription"></p>
              <p id="secondIndex" style="display: none;"></p>
              <p id="secondCallNum"></p>

              <div class="content_show">
              <!-- <div class="content_show" style="display: none;"> -->
                <button type="button" class="btn btn-danger btn-default" onclick="call('secondIndex')">为他打call</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section>
      <div class="container">
        <div class="row align-items-center">
          <div class="col-lg-6 order-lg-2">
            <div class="p-5">
              <img class="img-fluid rounded-circle" src="img/liaojunbo.jpg" alt="">
            </div>
          </div>
          <div class="col-lg-6 order-lg-1">
            <div class="p-5">
              <h2 class="display-4" id="thirdName"></h2>
              <p id="thirdDescription"></p>
              <p id="thirdCallNum"></p>
              <p id="thirdIndex" style="display: none;"></p>

              <div class="content_show">
              <!-- <div class="content_show" style="display: none;"> -->
                <button type="button" class="btn btn-danger btn-default" onclick="call('thirdIndex')">为他打call</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section>
      <div class="container">
        <div class="row align-items-center">
          <div class="col-lg-6">
            <div class="p-5">
              <img class="img-fluid rounded-circle" src="img/luoyang.jpg" alt="">
            </div>
          </div>
          <div class="col-lg-6">
            <div class="p-5">
              <h2 class="display-4" id="fourthName"></h2>
              <p id="fourthDescription"></p>
              <p id="fourthCallNum"></p>
              <p id="fourthIndex" style="display: none;"></p>

              <div class="content_show">
              <!-- <div class="content_show" style="display: none;"> -->
                <button type="button" class="btn btn-danger btn-default" onclick="call('fourthIndex')">为他打call</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="py-5 bg-black">

      <div class="container">
         <div align="center">
          <img src="./img/logo_white.png" width="180" height="60" >
         </div>
<!--        <div class="m-0 text-center text-white small">用星云链记录和宣传英雄事迹 <a href="mailto:rickliu414149871@gmail.com">联系我</a></div> 
 -->
        <p class="m-0 text-center text-white small">Copyright © 2018 英雄 <a href="mailto:rickliu414149871@gmail.com">联系我</a></p>
      </div>
    </footer>

    <!-- Bootstrap core JavaScript -->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <script src="./dist/nebulas.js"></script>
    <script src="./dist/nebPay.js"></script>

    <!-- 判断是否安装钱包 -->
    <script type="text/javascript">
      if (typeof(webExtensionWallet) == 'undefined') {
        $(".noExtensionClass").show();
      } else {
        $(".content_show").show();
      }

      window.onload = function() {
        getMessage();
      };
    </script>

    <script>
      'use strict';

      var dappAddress = "n1gfsKzDgPimNrPqwx6hXtiVXLivPdZ1DEL";     //mainnet
      // var dappAddress = "n1f7BMaoBDiq3orDGgcF8UeCTjHcpG3t6iH";     //testnet
      var nebulas = require("nebulas"),
          Account = nebulas.Account,
          neb = new nebulas.Neb();

      neb.setRequest(new nebulas.HttpRequest("https://mainnet.nebulas.io"));
      // neb.setRequest(new nebulas.HttpRequest("https://testnet.nebulas.io"));
      var nasApi = neb.api;

      function getMessage() {
        var from = Account.NewAccount().getAddressString();
        var value = "0";
        var nonce = "0";
        var gas_price = "1000000";
        var gas_limit = "2000000";
        var callFunction = "getMessage";
        var address = "n1XfZsYC7dNmgVysW72S3EvFQy4xemindTW"
        var callArgs = "[\"" + address + "\"]";
        var contract = {
          "function" : callFunction,
          "args" : callArgs,
        }

        neb.api.call(from, dappAddress, value, nonce, gas_price, gas_limit, contract).then(function(resp) {
            cbSearch(resp);
        }).catch(function(err) {
            console.log("error : " + err.message);
        })
      }

      //return of search
      function cbSearch(resp) {
        var result = resp.result;
        
        result = JSON.parse(result);
        var message = result["message"]

        var names = ["firstName","secondName","thirdName","fourthName"];
        var descriptions = ["firstDescription","secondDescription","thirdDescription","fourthDescription"];
        var indexs = ["firstIndex","secondIndex","thirdIndex","fourthIndex"];
        var calls = ["firstCallNum","secondCallNum","thirdCallNum","fourthCallNum"];
        for (var i = 0; i < message.length; i++) {
          var object = message[i];
          var name = object["name"];
          var value = object["value"];
          var index = object["index"];
          var voteNum = object["voteNum"];
          console.log("name = "+ name + " value = " + value + " index = " + index + "voteNum = " + object["voteNum"]);
          document.getElementById(names[i]).innerHTML = name;
          document.getElementById(descriptions[i]).innerHTML = value;
          document.getElementById(indexs[i]).innerHTML = index;
          document.getElementById(calls[i]).innerHTML = "打call数: " + voteNum;
        }
      }

      function call(p_id) { 
        var messageIndex = document.getElementById(p_id).innerHTML
        setCall(messageIndex);
      }


      //NebPay
      var NebPay = require("nebpay");
      var nebPay = new NebPay();
      var serialNumber;   //交易序列号
      var intervalQuery;  //定时查询交易结果  

      function setCall(messageIndex) {
        var to = dappAddress;
        var value = "0";
        var callFunction = "setVote";
        var address = "n1XfZsYC7dNmgVysW72S3EvFQy4xemindTW";
        var callArgs = "[\"" + address + "\",\"" + messageIndex + "\"]";


        serialNumber = nebPay.call(to, value, callFunction, callArgs, {
          // qrcode: {
          //     showQRCode: true
          // },
          callback: NebPay.config.mainnetUrl, //在主网查询(默认值)
          // callback: NebPay.config.testnetUrl,    //在测试网查询
          listener: listener  //set listener for extension transaction result
      });
      }

      function listener(resp) {
        console.log("listener resp: " + JSON.stringify(resp))
        var result = resp;
        onrefreshClick(result["txhash"])
    }

    function onrefreshClick(txhash) {
      nasApi.getTransactionReceipt({hash: txhash}).then(function(receipt) {
            console.log("status = " + receipt.status);
            if (receipt.status == 1) {
            console.log("交易成功,处理后续任务...");
              clearInterval(intervalQuery)  //清除定时查询
              alert("打call成功");
            } else if (receipt.status == 0) {
                clearInterval(intervalQuery)  //清除定时查询
                alert("失败");
            } else {
              intervalQuery = setTimeout(() => {
                onrefreshClick(txhash);
            }, 1000);    //建议查询频率10-15s,因为星云链出块时间为15s,并且查询服务器限制每分钟最多查询10次。
            }
        });
    }

    </script>


  </body>
</html>